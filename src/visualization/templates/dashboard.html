{% extends "base.html" %}
{% block title %}Dashboard – openshrimp{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <h1 class="h3 mb-3">Task dashboard</h1>
  <div class="row mb-3">
    <div class="col-auto">
      <label for="project-select" class="form-label">Project</label>
      <select id="project-select" class="form-select form-select-sm" style="min-width: 200px;">
        <option value="">All projects</option>
        {% for p in projects %}
        <option value="{{ p.id }}" {% if selected_project_id == p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="board mb-4">
    <div class="row flex-nowrap overflow-auto">
      {% for status in statuses %}
      <div class="col board-column" data-status="{{ status.value }}">
        <div class="card h-100">
          <div class="card-header py-2 text-center text-uppercase small fw-bold">{{ status.value.replace('_', ' ') }}</div>
          <div class="card-body p-2 board-column-cards" data-status="{{ status.value }}">
            {% for task in tasks_by_status[status.value] %}
            <div class="task-card card mb-2 shadow-sm" data-task-id="{{ task.id }}" draggable="true" role="button" tabindex="0">
              <div class="card-body py-2 px-3">
                <span class="task-title fw-medium">{{ task.title }}</span>
                <small class="text-muted d-block mt-1 task-time">{{ task.updated_at.strftime('%d %b %H:%M') if task.updated_at else '—' }}</small>
                {% set desc = task.description or '' %}
                {% if desc %}<p class="small text-body-secondary mt-1 mb-0 task-description">{{ desc[:250] }}{% if desc|length > 250 %}...{% endif %}</p>{% endif %}
                <div class="small text-muted mt-1">
                  {% if task.priority %}<span class="badge bg-secondary">{{ task.priority.value }}</span>{% endif %}
                  {% if task.assignee_id %}<span class="badge bg-info">Assignee {{ task.assignee_id }}</span>{% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <h2 class="h5 mb-2">Tasks table</h2>
  <table id="tasks-table" class="table table-striped table-bordered" style="width:100%">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Status</th>
        <th>Priority</th>
        <th>Assignee</th>
        <th>Updated</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for task in tasks %}
      <tr data-task-id="{{ task.id }}">
        <td>{{ task.id }}</td>
        <td>{{ task.title }}</td>
        <td>{{ task.status.value }}</td>
        <td>{{ task.priority.value }}</td>
        <td>{% if task.assignee_id %}{{ task.assignee_id }}{% else %}—{% endif %}</td>
        <td>{{ task.updated_at.strftime('%Y-%m-%d %H:%M') if task.updated_at else '—' }}</td>
        <td><button type="button" class="btn btn-sm btn-outline-primary edit-task" data-task-id="{{ task.id }}">Edit</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="modal fade" id="editTaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-task-id">
        <div class="mb-3">
          <label for="edit-title" class="form-label">Title</label>
          <input type="text" class="form-control" id="edit-title" required>
        </div>
        <div class="mb-3">
          <label for="edit-description" class="form-label">Description</label>
          <textarea class="form-control" id="edit-description" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label for="edit-priority" class="form-label">Priority</label>
          <select class="form-select" id="edit-priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="edit-assignee" class="form-label">Assignee</label>
          <select class="form-select" id="edit-assignee">
            <option value="">Unassigned</option>
            {% for u in assignee_options %}
            <option value="{{ u.id }}">{{ u.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger me-auto" id="edit-delete">Delete</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="edit-save">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  const DEFAULT_USER_ID = {{ default_user_id }};
  const DASHBOARD_TOKEN = {{ token | tojson | safe }};
  const SELECTED_PROJECT_ID = {{ selected_project_id if selected_project_id is not none else 'null' }};
  const TASKS_JSON = {{ tasks_serialized | tojson | safe }};
  const ASSIGNEE_OPTIONS = {{ assignee_options | tojson | safe }};
</script>
<script src="/static/js/dashboard.js"></script>
{% endblock %}
